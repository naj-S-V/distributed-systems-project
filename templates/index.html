{% extends "base.html" %}
{% block title %}Create Short Link{% endblock %}
{% block content %}
<h2>Create a new Short Link</h2>
<form id="shorten-form">
    <label for="url">Original URL:</label><br>
    <input type="url" id="url" name="url" required style="width: 80%; padding: 8px;">
    <button type="submit" class="btn">Shorten</button>
</form>
<hr>
<h3>üîß Database Migration Demo</h3>
<p>This will add a new field <code>category = "general"</code> to all links that don't have it.</p>
<button class="btn" onclick="runMigration()">Run Migration</button>
<button class="btn" style="background:#007bff;" onclick="checkMigrationStatus()">Check Status</button>
<div id="migration-result" style="margin-top:10px;"></div>

<script>
async function runMigration() {
    const div = document.getElementById("migration-result");
    div.innerHTML = "‚è≥ Running migration...";
    try {
        const res = await fetch("/run_migration", { method: "POST" });
        const data = await res.json();
        if (data.success) {
            div.innerHTML = `<strong style="color:green;">${data.message}</strong>`;
        } else {
            div.innerHTML = `<strong style="color:red;">Error:</strong> ${data.error}`;
        }
    } catch (err) {
        div.innerHTML = `<strong style="color:red;">${err.message}</strong>`;
    }
}

async function checkMigrationStatus() {
    const div = document.getElementById("migration-result");
    div.innerHTML = "‚è≥ Checking...";
    try {
        const res = await fetch("/api/migration_status");
        const data = await res.json();
        div.innerHTML = `
            <strong>Total links:</strong> ${data.total_links}<br>
            <strong>Migrated:</strong> ${data.migrated_links}<br>
            <strong>Pending:</strong> ${data.pending}
        `;
    } catch (err) {
        div.innerHTML = `<strong style="color:red;">${err.message}</strong>`;
    }
}
</script>


<div id="result" style="margin-top: 20px;"></div>

<script>
document.getElementById("shorten-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const url = document.getElementById("url").value;
    const resultDiv = document.getElementById("result");

    resultDiv.innerHTML = "Processing...";
    try {
        const res = await fetch("/api/shorten", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ original_url: url })
        });
        const data = await res.json();
        if (res.ok) {
            resultDiv.innerHTML = `
                <p><strong>Short URL:</strong> 
                <a href="/r/${data.short_code}" target="_blank">${window.location.origin}/r/${data.short_code}</a></p>`;
        } else {
            resultDiv.innerHTML = `<span style="color:red;">Error: ${data.detail || 'Unknown error'}</span>`;
        }
    } catch (err) {
        resultDiv.innerHTML = `<span style="color:red;">${err.message}</span>`;
    }
});
</script>
{% endblock %}
