apiVersion: v1
kind: ConfigMap
metadata:
  name: init-app-script
data:
  init_app.py: |-
    import sys
    from pymongo import MongoClient, errors

    NS_FILE = "/var/run/secrets/kubernetes.io/serviceaccount/namespace"
    with open(NS_FILE, "r") as f:
        ns = f.read().strip()

    mongo_uri = f"mongodb://mongos.{ns}.svc.cluster.local:27017"
    db_name = f"shortener_{ns}"

    print(f"ğŸš€ Namespace: {ns}")
    print(f"ğŸ”— URI: {mongo_uri}")
    print(f"ğŸ—„ï¸  Target DB: {db_name}")

    try:
        client = MongoClient(mongo_uri, serverSelectionTimeoutMS=5000)
        client.admin.command("ping")
        print("âœ… Connected to mongos")
    except Exception as e:
        print(f"âŒ Cannot connect to mongos: {e}")
        sys.exit(1)

    db = client[db_name]

    # Create collections if missing
    wanted = ["links", "users", "stats"]
    existing = set(db.list_collection_names())
    for coll in wanted:
        if coll not in existing:
            db.create_collection(coll)
            print(f"âœ… Created collection: {coll}")
        else:
            print(f"â„¹ï¸  Collection already exists: {coll}")

    # Indexes
    try:
        db["links"].create_index("short_code", unique=True)
        print("âœ… Index links.short_code (unique)")
    except errors.OperationFailure as e:
        print(f"â„¹ï¸  Index links.short_code exists or skipped: {e}")

    try:
        db["users"].create_index("email", unique=True)
        print("âœ… Index users.email (unique)")
    except errors.OperationFailure as e:
        print(f"â„¹ï¸  Index users.email exists or skipped: {e}")

    # Sharding
    try:
        print("âš™ï¸  enableSharding...")
        client.admin.command("enableSharding", db_name)
    except errors.OperationFailure as e:
        if "already enabled" in str(e).lower():
            print("â„¹ï¸  Sharding already enabled")
        else:
            print(f"âŒ enableSharding error: {e}")
            sys.exit(1)

    try:
        print("âš™ï¸  shardCollection on links (_id hashed)...")
        client.admin.command("shardCollection", f"{db_name}.links", key={"_id": "hashed"})
    except errors.OperationFailure as e:
        if "already sharded" in str(e).lower():
            print("â„¹ï¸  Collection already sharded")
        else:
            print(f"âŒ shardCollection error: {e}")
            sys.exit(1)

    print(f"ğŸ‰ Initialization complete for DB: {db_name}")
